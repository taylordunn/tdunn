---
title: "TidyTuesday 2020 Week 28"
description: |
  #TidyTuesday 2020-07-07: Coffee Ratings.
author:
  - name: Taylor Dunn
date: 2020-07-12
params:
  date: 2020-07-12
  slug: "tidytuesday-2020-week-28"
categories:
  - TidyTuesday
  - tidymodels
  - machine learning
  - random forest
draft: true
output:
  distill::distill_article:
    toc: true
    self_contained: false
#bibliography: references.bib
---

```{r setup, include=TRUE, code_folding="Setup"}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidytuesdayR)
library(gt)
library(rmarkdown)
library(patchwork)

library(dunnr)
extrafont::loadfonts(device = "win", quiet = TRUE)
theme_set(theme_td())
set_geom_fonts()
# A coffee themed palette I found here: https://colorpalettes.net/color-palette-4281/
#set_palette()
coffee_pal <- c("#a0583c", "#c08267", "#ccb9b1", "#616063", "#212123")
options(ggplot2.discrete.color = coffee_pal,
        ggplot2.discrete.fill = coffee_pal)
```

# Load the data

```{r}
tt <- tidytuesdayR::tt_load("2020-07-07")
```

```{r eval=FALSE}
# Check out the README
tt
```

These data were scraped by James LeDoux in 2018 from the Coffee Quality Institute (see the original data [here](https://github.com/jldbc/coffee-quality-database)).

# Data exploration

```{r}
coffee <- tt$coffee_ratings
```

For my own convenience, I've copied [data dictionary](https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-07-07/readme.md) below:

|variable              |class     |description |
|:---------------------|:---------|:-----------|
|total_cup_points      |double    | Total rating/points (0 - 100 scale) |
|species               |character | Species of coffee bean (arabica or robusta) |
|owner                 |character | Owner of the farm |
|country_of_origin     |character | Where the bean came from |
|farm_name             |character | Name of the farm |
|lot_number            |character | Lot number of the beans tested |
|mill                  |character | Mill where the beans were processed |
|ico_number            |character | International Coffee Organization number |
|company               |character | Company name |
|altitude              |character | Altitude - this is a messy column - I've left it for some cleaning  |
|region                |character | Region where bean came from |
|producer              |character | Producer of the roasted bean |
|number_of_bags        |double    | Number of bags tested |
|bag_weight            |character | Bag weight tested |
|in_country_partner    |character | Partner for the country |
|harvest_year          |character | When the beans were harvested (year) |
|grading_date          |character | When the beans were graded|
|owner_1               |character | Who owns the beans|
|variety               |character | Variety of the beans |
|processing_method     |character | Method for processing|
|aroma                 |double    | Aroma grade |
|flavor                |double    | Flavor grade |
|aftertaste            |double    | Aftertaste grade |
|acidity               |double    | Acidity grade |
|body                  |double    | Body grade |
|balance               |double    | Balance grade |
|uniformity            |double    | Uniformity grade |
|clean_cup             |double    | Clean cup grade |
|sweetness             |double    | Sweetness grade |
|cupper_points         |double    | Cupper Points|
|moisture              |double    | Moisture Grade|
|category_one_defects  |double    | Category one defects (count) |
|quakers               |double    | quakers|
|color                 |character | Color of bean |
|category_two_defects  |double    |Category two defects (count)  |
|expiration            |character | Expiration date of the beans |
|certification_body    |character | Who certified it |
|certification_address |character | Certification body address |
|certification_contact |character | Certification contact |
|unit_of_measurement   |character | Unit of measurement |
|altitude_low_meters   |double    | Altitude low meters|
|altitude_high_meters  |double    | Altitude high meters |
|altitude_mean_meters  |double    | Altitude mean meters |

A lot of variables to consider here.
Summarize them with `skimr`:

```{r}
skimr::skim(coffee)
```

## Ratings

The key outcome variable is `total_cup_points`, which is a quality rating 0-100

```{r fig.height=2, fig.width=4}
p <- coffee %>%
  ggplot(aes(x = total_cup_points)) +
  geom_boxplot(y = 0, fill = coffee_pal[1], outlier.shape = NA) +
  geom_jitter(aes(y = 1), color = coffee_pal[2],
              alpha = 0.3, height = 0.3, width = 0) +
  remove_axis("y")
p
```

A very obvious outlier at `total_cup_points` = `r min(coffee$total_cup_points)`

```{r}
coffee %>%
  filter(total_cup_points == min(total_cup_points)) %>%
  glimpse()
```

All of the gradings (`aroma`, `flavor`, etc.) are also 0.
Remove it:

```{r fig.height=2, fig.width=4}
coffee <- coffee %>% filter(total_cup_points > 0)
p %+% coffee
```

Show the distribution of the other numerical gradings:

```{r}
coffee %>%
  select(aroma:moisture) %>%
  pivot_longer(cols = everything()) %>%
  ggplot(aes(x = value)) +
  geom_boxplot(y = 0, fill = coffee_pal[1], outlier.shape = NA) +
  geom_jitter(aes(y = 1), color = coffee_pal[2],
              alpha = 0.3, height = 0.3, width = 0) +
  remove_axis("y") +
  facet_wrap(~name, ncol = 3)
```

None of the values are missing, and they all seem to range from 0 to 10, except for `moisture`:

```{r fig.height=2, fig.width=4}
coffee %>%
  ggplot(aes(x = moisture)) +
  geom_boxplot(y = 0, fill = coffee_pal[1], outlier.shape = NA) +
  geom_jitter(aes(y = 1), color = coffee_pal[2],
              alpha = 0.3, height = 0.3, width = 0) +
  remove_axis("y")
```

What is the relationship between the individual gradings and the overall `total_cup_points`?
There are 10 gradings with scores 0-10, so I assume adding them together gives `total_cup_points`, which ranges 0-100:

```{r fig.height=3, fig.width=3}
coffee %>%
  rowwise() %>%
  transmute(
    total_cup_points,
    sum_gradings = sum(c_across(aroma:cupper_points))
  ) %>%
  ggplot(aes(x = total_cup_points, y = sum_gradings)) +
  geom_point(color = coffee_pal[1], size = 2) +
  geom_abline(size = 1)
```

Some very slight deviations, but yes my assumption is correct.
A second assumption: there will be mostly positive associations among the individual gradings (e.g. a coffee with high `flavor` will have high `body` on average).
Compute and plot the pairwise correlations with `corrr`:

```{r message=FALSE, fig.width=6}
coffee %>%
  select(aroma:cupper_points) %>%
  corrr::correlate(method = "pearson", use = "everything") %>%
  corrr::rplot() +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.7))
```

Yes, lots of high correlations.
Interestingly, there are three variables in particular (`uniformity`, `clean_cup` and `sweetness`) which correlate moderately with eachother, and weakly with the others.

## Categorical variables

There are two `species`, though Arabica makes up the large majority:

```{r}
coffee %>% count(species)
```

Interesting that Arabica makes up `r scales::percent(mean(coffee$species == "Arabica"))` of the data, but ~60% of the coffee produced worldwide.

There are `r n_distinct(coffee$country_of_origin, na.rm = T)` countries of origin (`r sum(is.na(coffee$country_of_origin))` value missing):

```{r fig.height=6}
coffee %>%
  count(country_of_origin, sort = TRUE) %>%
  mutate(
    country_of_origin = country_of_origin %>%
      fct_explicit_na() %>%
      fct_reorder(n)
  ) %>%
  ggplot(aes(y = country_of_origin, x = n)) +
  geom_col(fill = coffee_pal[1]) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.1))) +
  labs(y = NULL)
```

For the most frequent countries, show the distribution of overall ratings:

```{r}
coffee %>%
  mutate(
    country_of_origin  = country_of_origin %>%
      fct_explicit_na() %>%
      fct_lump(n = 10) %>%
      fct_reorder(total_cup_points)
  ) %>%
  ggplot(aes(y = country_of_origin, x = total_cup_points)) +
  geom_boxplot(fill = coffee_pal[3]) +
  labs(y = NULL)
```

Ethiopian coffee has a very clear lead in terms of ratings, while Colombia has very consistently high ratings.

```{r}
coffee %>%
  mutate(
    variety = variety %>%
      fct_explicit_na() %>%
      fct_lump_min(10, other_level = "Other (n<10)")
  ) %>%
  count(variety) %>%
  mutate(variety = fct_reorder(variety, n)) %>%
  ggplot(aes(y = variety, x = n)) +
  geom_col(fill = coffee_pal[2]) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.1))) +
  labs(y = NULL)
```

There are two unknown values for `variety`: "Other" and `NA` (Missing).
These could have different meanings (e.g. an `NA` value could be a common variety but is just missing) but I will combine both:

```{r}
coffee <- coffee %>%
  mutate(variety = ifelse(variety == "Other", NA_character_, variety))
```

`in_country_partner` has a manageable number of unique values (`r n_distinct(coffee$in_country_partner)`)

```{r}
d <- coffee %>%
  mutate(
    in_country_partner = fct_lump(in_country_partner, 10)
  ) %>%
  add_count(in_country_partner) %>%
  mutate(in_country_partner = fct_reorder(in_country_partner, n))
p1 <- d %>%
  distinct(in_country_partner, n) %>%
  ggplot(aes(y = in_country_partner, x = n)) +
  geom_col(fill = coffee_pal[1]) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.1))) +
  labs(y = NULL)
p2 <- d %>%
  ggplot(aes(y = in_country_partner, x = total_cup_points)) +
  geom_boxplot(fill = coffee_pal[2]) +
  labs(y = NULL) +
  theme(axis.text.y = element_blank())
p1 | p2
```


```{r}
coffee %>% count(farm_name, sort = T)
```


```{r}
coffee %>% count(harvest_year)
```



# Reproducibility {.appendix}

<details><summary>Session info</summary>

```{r echo=FALSE}
devtools::session_info()$platform
devtools::session_info()$packages %>%
  rmarkdown::paged_table()
```

</details>

<details><summary>Git repository</summary>

```{r echo=FALSE}
git2r::repository()
```

</details>

```{r echo=FALSE}
get_distill_source(date = params$date, slug = params$slug)
```


